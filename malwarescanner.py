import os
import yara
from collections import defaultdict
import re
from openpyxl import Workbook

# === CONFIGURATION ===
YARA_RULES_FILE = "file_sigs.yar"
SCAN_PATHS = [
    "C:\\",
    "D:\\"
]
MAX_FILE_SIZE = 1024 * 1024 * 100  # 100 MB
OUTPUT_FILE = "yara_scan_results.xlsx"


def scan_file(rules, file_path):
    try:
        if os.path.getsize(file_path) > MAX_FILE_SIZE:
            return []

        matches = rules.match(file_path)
        return [match.rule for match in matches]

    except (PermissionError, OSError, yara.Error):
        return []


def get_file_type(file_path):
    ext = os.path.splitext(file_path)[1].lower()
    return ext if ext else "NO_EXTENSION"


def scan_paths(rules, paths):
    """
    Returns:
    {
        file_type: {
            "MATCH": [(file_path, rule)],
            "NO_MATCH": [file_path]
        }
    }
    """
    grouped = defaultdict(lambda: {"MATCH": [], "NO_MATCH": []})

    for base_path in paths:
        for root, _, files in os.walk(base_path):
            for file in files:
                full_path = os.path.join(root, file)
                file_type = get_file_type(full_path)

                matches = scan_file(rules, full_path)

                if matches:
                    for rule in matches:
                        grouped[file_type]["MATCH"].append((full_path, rule))
                else:
                    grouped[file_type]["NO_MATCH"].append(full_path)

    return grouped


def write_excel(results):
    wb = Workbook()
    wb.remove(wb.active)  # remove default sheet

    for file_type, data in results.items():
        sheet_name = file_type.replace(".", "")[:31]  # Excel sheet name limit
        ws = wb.create_sheet(title=sheet_name)

        ws.append(["File Path", "File Type", "YARA Rule"])

        for file_path, rule in data["MATCH"]:
            ws.append([file_path, file_type, rule])

        for file_path in data["NO_MATCH"]:
            ws.append([file_path, file_type, "NO_MATCH"])

    wb.save(OUTPUT_FILE)


def main():
    print("[*] Compiling YARA rules...")
    rules = yara.compile(filepath=YARA_RULES_FILE)

    print("[*] Scanning filesystem...")
    results = scan_paths(rules, SCAN_PATHS)

    print("[*] Writing Excel output...")
    write_excel(results)

    print(f"[+] Scan complete. Results saved to {OUTPUT_FILE}")


if __name__ == "__main__":
    main()
