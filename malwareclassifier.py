import os
import csv
import yara
from tqdm import tqdm

# ================= CONFIG =================
TARGET_FOLDER = r"C:\Users\John\Desktop\File"
YARA_RULES_FILE = "file_sigs.yar"
OUTPUT_CSV = "yara_scan_results.csv"
MAX_READ_BYTES = 50
# ==========================================


def get_first_50_bytes(path):
    try:
        with open(path, "rb") as f:
            data = f.read(MAX_READ_BYTES)
            return data, data.hex(" ")
    except Exception:
        return None, None


def get_header_length(rule):
    """
    Returns the length (in bytes) of the longest $header string
    that matched in a YARA rule.
    """
    max_len = 0
    for s in rule.strings:
        if s.identifier == "$header":
            for instance in s.instances:
                max_len = max(max_len, len(instance.matched_data))
    return max_len


def scan():
    rules = yara.compile(filepath=YARA_RULES_FILE)

    results = []

    all_files = []
    for root, _, files in os.walk(TARGET_FOLDER):
        for name in files:
            all_files.append(os.path.join(root, name))

    print(f"[*] Scanning {len(all_files)} files...")

    for file_path in tqdm(all_files, desc="Classifying", unit="file"):
        raw_bytes, hex_bytes = get_first_50_bytes(file_path)
        if raw_bytes is None:
            continue

        try:
            matches = rules.match(data=raw_bytes)
        except Exception:
            matches = []

        # Default type
        file_type = "None"

        if matches:
            best_rule = None
            best_len = -1

            for rule in matches:
                header_len = get_header_length(rule)
                if header_len > best_len:
                    best_len = header_len
                    best_rule = rule

            if best_rule:
                file_type = best_rule.rule

        results.append({
            "File_Location": os.path.dirname(file_path),
            "File_Name": os.path.basename(file_path),
            "File_Type": file_type,
            "First_50_Bytes": hex_bytes
        })

    # Write CSV
    if results:
        with open(OUTPUT_CSV, "w", newline="", encoding="utf-8") as f:
            writer = csv.DictWriter(
                f,
                fieldnames=[
                    "File_Location",
                    "File_Name",
                    "File_Type",
                    "First_50_Bytes"
                ]
            )
            writer.writeheader()
            writer.writerows(results)

        print(f"\n[+] Processed {len(results)} files â†’ {OUTPUT_CSV}")
    else:
        print("\n[-] No files processed.")


if __name__ == "__main__":
    scan()
